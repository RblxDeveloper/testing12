rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

  // ============ Helper Functions ============
  function isSignedIn() {
    return request.auth != null;
  }

  function getUserData() {
    return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
  }

  function isParent() {
    return isSignedIn() && getUserData().role == 'parent';
  }

  function isChild() {
    return isSignedIn() && getUserData().role == 'child';
  }

  function isSameFamily(familyCode) {
    return isSignedIn() && getUserData().familyCode == familyCode;
  }

  // ============ Collections ============

  // Users collection
  match /users/{userId} {
    allow read: if isSignedIn() && request.auth.uid == userId;
    allow get, list: if resource.data.role == 'parent';
    allow read: if isSignedIn() && isParent();
    allow read: if isSignedIn() && isChild() && resource.data.familyCode == getUserData().familyCode;
    allow create: if isSignedIn() && request.auth.uid == userId;
    allow update: if isSignedIn() && request.auth.uid == userId;
    allow update: if isSignedIn() && isParent() && resource.data.familyCode == getUserData().familyCode && resource.data.role == 'child';
  }

  // Task Templates collection
  match /taskTemplates/{taskId} {
    allow read: if isSignedIn() && isSameFamily(resource.data.familyCode);
    allow create: if isSignedIn() && isParent();
    allow update, delete: if isSignedIn() && isParent() && isSameFamily(resource.data.familyCode);
  }

  // Rewards collection
  match /rewards/{rewardId} {
    allow read: if isSignedIn() && isSameFamily(resource.data.familyCode);
    allow create: if isSignedIn() && isParent();
    allow update, delete: if isSignedIn() && isParent() && isSameFamily(resource.data.familyCode);
  }

  // Submissions collection
  match /submissions/{submissionId} {
    allow create: if isSignedIn() && isChild() && request.resource.data.userId == request.auth.uid && request.resource.data.familyCode == getUserData().familyCode;
    allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
    allow read: if isSignedIn() && isParent() && resource.data.familyCode == getUserData().familyCode;
    allow update: if isSignedIn() && isParent() && resource.data.familyCode == getUserData().familyCode;
  }

  // Redeemed Rewards collection
  match /redeemedRewards/{redeemId} {
    allow create: if isSignedIn() && isChild() && request.resource.data.userId == request.auth.uid && request.resource.data.familyCode == getUserData().familyCode;
    allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
    allow read: if isSignedIn() && isParent() && resource.data.familyCode == getUserData().familyCode;
  }

  // Notifications collection
  match /notifications/{notificationId} {
    allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
    allow create: if isSignedIn() && isParent() && request.resource.data.familyCode == getUserData().familyCode;
    allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
  }

  }
}